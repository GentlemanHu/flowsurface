name: "Release"

permissions:
    contents: write
on:
    workflow_dispatch:
        inputs:
            tag:
                description: "Specify tag to create"
                required: true
            # Platform selection - all default to false except Windows
            build_windows:
                description: "ðŸªŸ Build Windows x64"
                type: boolean
                default: true
            build_linux_x64:
                description: "ðŸ§ Build Linux x64"
                type: boolean
                default: false
            build_linux_arm:
                description: "ðŸ§ Build Linux ARM64"
                type: boolean
                default: false
            build_macos_arm:
                description: "ðŸŽ Build macOS ARM (Apple Silicon)"
                type: boolean
                default: false
            build_macos_x64:
                description: "ðŸŽ Build macOS x64 (Intel)"
                type: boolean
                default: false
            build_macos_universal:
                description: "ðŸŽ Create macOS Universal Binary (requires both macOS builds)"
                type: boolean
                default: false
            # Release options
            create_release:
                description: "ðŸ“¦ Create GitHub Release (false = tag only)"
                type: boolean
                default: false
            create_signed_tag:
                description: "ðŸ” Create GPG signed tag (requires GPG secrets)"
                type: boolean
                default: false

jobs:
    # Only run if signed tag is requested AND secrets are available
    create-signed-tag:
        name: Create Signed Tag
        runs-on: ubuntu-latest
        if: ${{ inputs.create_signed_tag }}
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Check GPG secrets availability
              id: check_secrets
              run: |
                  if [ -z "${{ secrets.GPG_PRIVATE_KEY }}" ]; then
                    echo "âš ï¸ GPG_PRIVATE_KEY secret not found, skipping signed tag"
                    echo "has_gpg=false" >> "$GITHUB_OUTPUT"
                  else
                    echo "has_gpg=true" >> "$GITHUB_OUTPUT"
                  fi

            - name: Import GPG key and configure Git
              if: steps.check_secrets.outputs.has_gpg == 'true'
              env:
                  GPG_NAME: ${{ secrets.GPG_NAME }}
                  GPG_EMAIL: ${{ secrets.GPG_EMAIL }}
              run: |
                  echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
                  echo "allow-loopback-pinentry" > ~/.gnupg/gpg-agent.conf
                  echo "pinentry-mode loopback" > ~/.gnupg/gpg.conf
                  gpg-connect-agent reloadagent /bye
                  KEY_ID=$(gpg --list-secret-keys --with-colons | awk -F: '/^fpr:/ {print $10; exit}')
                  git config user.name "${GPG_NAME}"
                  git config user.email "${GPG_EMAIL}"
                  git config user.signingkey "$KEY_ID"
                  cat > "$RUNNER_TEMP/gpg-wrapper.sh" << 'EOF'
                  #!/usr/bin/env bash
                  exec gpg --batch --yes --pinentry-mode loopback --passphrase "$GPG_PASSPHRASE" "$@"
                  EOF
                  chmod +x "$RUNNER_TEMP/gpg-wrapper.sh"
                  git config gpg.program "$RUNNER_TEMP/gpg-wrapper.sh"

            - name: Create signed tag
              if: steps.check_secrets.outputs.has_gpg == 'true'
              env:
                  TAG: ${{ github.event.inputs.tag }}
                  GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
              run: |
                  if git rev-parse "refs/tags/$TAG" >/dev/null 2>&1; then
                    echo "Tag $TAG already exists, skipping."
                    exit 0
                  fi
                  git tag -s "$TAG" -m "Release $TAG" HEAD
                  git push origin "refs/tags/$TAG"

            - name: Create unsigned tag (fallback)
              if: steps.check_secrets.outputs.has_gpg == 'false'
              env:
                  TAG: ${{ github.event.inputs.tag }}
              run: |
                  if git rev-parse "refs/tags/$TAG" >/dev/null 2>&1; then
                    echo "Tag $TAG already exists, skipping."
                    exit 0
                  fi
                  git tag "$TAG" -m "Release $TAG" HEAD
                  git push origin "refs/tags/$TAG"

    # Create unsigned tag if signed tag is not requested
    create-unsigned-tag:
        name: Create Unsigned Tag
        runs-on: ubuntu-latest
        if: ${{ !inputs.create_signed_tag }}
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Create tag
              env:
                  TAG: ${{ github.event.inputs.tag }}
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  if git rev-parse "refs/tags/$TAG" >/dev/null 2>&1; then
                    echo "Tag $TAG already exists, skipping."
                    exit 0
                  fi
                  git tag "$TAG" -m "Release $TAG" HEAD
                  git push origin "refs/tags/$TAG"

    build-windows:
        name: "ðŸªŸ Windows x64"
        runs-on: windows-latest
        if: ${{ inputs.build_windows }}
        steps:
            - uses: actions/checkout@v3
            - uses: actions-rs/toolchain@v1
              with:
                  profile: minimal
                  toolchain: stable
                  override: true

            - name: Configure optimized release profile
              shell: bash
              run: |
                  if grep -q "\[profile.release\]" Cargo.toml; then
                    sed -i '/\[profile.release\]/,/^\[/s/^lto.*//g' Cargo.toml
                    sed -i '/\[profile.release\]/,/^\[/s/^codegen-units.*//g' Cargo.toml
                    sed -i '/\[profile.release\]/,/^\[/s/^opt-level.*//g' Cargo.toml
                    sed -i '/\[profile.release\]/a opt-level = 3\ncodegen-units = 1\nlto = "fat"' Cargo.toml
                  else
                    cat >> Cargo.toml << EOF

                  [profile.release]
                  lto = "fat"
                  codegen-units = 1
                  opt-level = 3
                  EOF
                  fi
                  rm -f .cargo/config.toml

            - name: Build
              run: bash scripts/build-windows.sh x86_64

            - name: Set artifact path
              run: echo "ARTIFACT_PATH=target/release/flowsurface-x86_64-windows.zip" >> $env:GITHUB_ENV

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: windows-x64
                  path: ${{ env.ARTIFACT_PATH }}

    build-linux-x64:
        name: "ðŸ§ Linux x64"
        runs-on: ubuntu-latest
        if: ${{ inputs.build_linux_x64 }}
        steps:
            - uses: actions/checkout@v3
            - uses: actions-rs/toolchain@v1
              with:
                  profile: minimal
                  toolchain: stable
                  override: true

            - name: Install linux deps
              run: |
                  sudo apt update
                  sudo apt install -y \
                    build-essential \
                    git \
                    pkg-config \
                    libudev-dev \
                    libxkbcommon-dev \
                    libasound2-dev

            - name: Configure optimized release profile
              shell: bash
              run: |
                  if grep -q "\[profile.release\]" Cargo.toml; then
                    sed -i '/\[profile.release\]/,/^\[/s/^lto.*//g' Cargo.toml
                    sed -i '/\[profile.release\]/,/^\[/s/^codegen-units.*//g' Cargo.toml
                    sed -i '/\[profile.release\]/,/^\[/s/^opt-level.*//g' Cargo.toml
                    sed -i '/\[profile.release\]/a opt-level = 3\ncodegen-units = 1\nlto = "fat"' Cargo.toml
                  else
                    cat >> Cargo.toml << EOF

                  [profile.release]
                  lto = "fat"
                  codegen-units = 1
                  opt-level = 3
                  EOF
                  fi
                  rm -f .cargo/config.toml

            - name: Build
              run: bash scripts/package-linux.sh package x86_64

            - name: Set artifact path
              run: echo "ARTIFACT_PATH=$(bash scripts/package-linux.sh archive_path x86_64)" >> "$GITHUB_ENV"

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: linux-x64
                  path: ${{ env.ARTIFACT_PATH }}

    build-linux-arm:
        name: "ðŸ§ Linux ARM64"
        runs-on: ubuntu-24.04-arm
        if: ${{ inputs.build_linux_arm }}
        steps:
            - uses: actions/checkout@v3
            - uses: actions-rs/toolchain@v1
              with:
                  profile: minimal
                  toolchain: stable
                  override: true

            - name: Install linux deps
              run: |
                  sudo apt update
                  sudo apt install -y \
                    build-essential \
                    git \
                    pkg-config \
                    libudev-dev \
                    libxkbcommon-dev \
                    libasound2-dev

            - name: Configure optimized release profile
              shell: bash
              run: |
                  if grep -q "\[profile.release\]" Cargo.toml; then
                    sed -i '/\[profile.release\]/,/^\[/s/^lto.*//g' Cargo.toml
                    sed -i '/\[profile.release\]/,/^\[/s/^codegen-units.*//g' Cargo.toml
                    sed -i '/\[profile.release\]/,/^\[/s/^opt-level.*//g' Cargo.toml
                    sed -i '/\[profile.release\]/a opt-level = 3\ncodegen-units = 1\nlto = "fat"' Cargo.toml
                  else
                    cat >> Cargo.toml << EOF

                  [profile.release]
                  lto = "fat"
                  codegen-units = 1
                  opt-level = 3
                  EOF
                  fi
                  rm -f .cargo/config.toml

            - name: Build
              run: bash scripts/package-linux.sh package aarch64

            - name: Set artifact path
              run: echo "ARTIFACT_PATH=$(bash scripts/package-linux.sh archive_path aarch64)" >> "$GITHUB_ENV"

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: linux-arm
                  path: ${{ env.ARTIFACT_PATH }}

    build-macos-arm:
        name: "ðŸŽ macOS ARM"
        runs-on: macos-latest
        if: ${{ inputs.build_macos_arm }}
        steps:
            - uses: actions/checkout@v3
            - uses: actions-rs/toolchain@v1
              with:
                  profile: minimal
                  toolchain: stable
                  override: true

            - name: Configure optimized release profile
              shell: bash
              run: |
                  if grep -q "\[profile.release\]" Cargo.toml; then
                    sed -i '' '/\[profile.release\]/,/^\[/s/^lto.*//g' Cargo.toml
                    sed -i '' '/\[profile.release\]/,/^\[/s/^codegen-units.*//g' Cargo.toml
                    sed -i '' '/\[profile.release\]/,/^\[/s/^opt-level.*//g' Cargo.toml
                    sed -i '' '/\[profile.release\]/a\
                  opt-level = 3\
                  codegen-units = 1\
                  lto = "fat"' Cargo.toml
                  else
                    cat >> Cargo.toml << EOF

                  [profile.release]
                  lto = "fat"
                  codegen-units = 1
                  opt-level = 3
                  EOF
                  fi
                  rm -f .cargo/config.toml

            - name: Build
              run: bash scripts/build-macos.sh aarch64

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: macos-arm
                  path: target/release/flowsurface-aarch64-macos.tar.gz

    build-macos-x64:
        name: "ðŸŽ macOS x64"
        runs-on: macos-15-intel
        if: ${{ inputs.build_macos_x64 }}
        steps:
            - uses: actions/checkout@v3
            - uses: actions-rs/toolchain@v1
              with:
                  profile: minimal
                  toolchain: stable
                  override: true

            - name: Configure macOS x64 release profile (thin LTO)
              shell: bash
              run: |
                  if grep -q "\[profile.release\]" Cargo.toml; then
                    sed -i '' '/\[profile.release\]/,/^\[/s/^lto.*//g' Cargo.toml
                    sed -i '' '/\[profile.release\]/,/^\[/s/^codegen-units.*//g' Cargo.toml
                    sed -i '' '/\[profile.release\]/,/^\[/s/^opt-level.*//g' Cargo.toml
                    sed -i '' '/\[profile.release\]/a\
                  opt-level = 3\
                  codegen-units = 1\
                  lto = "thin"' Cargo.toml
                  else
                    cat >> Cargo.toml << EOF

                  [profile.release]
                  lto = "thin"
                  codegen-units = 1
                  opt-level = 3
                  EOF
                  fi
                  rm -f .cargo/config.toml

            - name: Build
              run: bash scripts/build-macos.sh x86_64

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: macos-x64
                  path: target/release/flowsurface-x86_64-macos.tar.gz

    create-macos-universal:
        name: "ðŸŽ Create Universal macOS Binary"
        needs: [build-macos-arm, build-macos-x64]
        runs-on: macos-latest
        if: ${{ inputs.build_macos_universal && inputs.build_macos_arm && inputs.build_macos_x64 }}
        steps:
            - name: Download arm artifact
              uses: actions/download-artifact@v4
              with:
                  name: macos-arm
                  path: macos-arm

            - name: Download x64 artifact
              uses: actions/download-artifact@v4
              with:
                  name: macos-x64
                  path: macos-x64

            - name: Extract and create universal binary
              run: |
                  mkdir -p macos-arm/extracted macos-x64/extracted target/release
                  tar -xzf macos-arm/flowsurface-aarch64-macos.tar.gz -C macos-arm/extracted
                  tar -xzf macos-x64/flowsurface-x86_64-macos.tar.gz -C macos-x64/extracted
                  lipo macos-arm/extracted/flowsurface macos-x64/extracted/flowsurface -create -output target/release/flowsurface
                  tar -czf target/release/flowsurface-universal-macos.tar.gz -C target/release flowsurface

            - name: Upload universal artifact
              uses: actions/upload-artifact@v4
              with:
                  name: macos-universal
                  path: target/release/flowsurface-universal-macos.tar.gz

    create-release:
        name: "ðŸ“¦ Create Release"
        needs:
            - build-windows
            - build-linux-x64
            - build-linux-arm
            - build-macos-arm
            - build-macos-x64
            - create-macos-universal
        # Always run but only if create_release is true
        if: ${{ always() && inputs.create_release }}
        runs-on: ubuntu-latest
        outputs:
            upload_url: ${{ steps.create-release.outputs.upload_url }}
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        steps:
            - name: Create Release
              id: create-release
              uses: actions/create-release@v1
              with:
                  tag_name: ${{ github.event.inputs.tag }}
                  release_name: ${{ github.event.inputs.tag }}
                  draft: true
                  prerelease: false

    add-assets:
        needs: create-release
        name: "ðŸ“Ž Add Assets"
        if: ${{ always() && inputs.create_release && needs.create-release.result == 'success' }}
        runs-on: ubuntu-latest
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        steps:
            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts
              continue-on-error: true

            - name: List downloaded artifacts
              run: ls -la artifacts/ || echo "No artifacts directory"

            - name: Upload Windows asset
              if: ${{ inputs.build_windows }}
              uses: actions/upload-release-asset@v1
              with:
                  upload_url: ${{ needs.create-release.outputs.upload_url }}
                  asset_path: ./artifacts/windows-x64/flowsurface-x86_64-windows.zip
                  asset_name: flowsurface-x86_64-windows.zip
                  asset_content_type: application/zip
              continue-on-error: true

            - name: Upload Linux x64 asset
              if: ${{ inputs.build_linux_x64 }}
              uses: actions/upload-release-asset@v1
              with:
                  upload_url: ${{ needs.create-release.outputs.upload_url }}
                  asset_path: ./artifacts/linux-x64/flowsurface-x86_64-linux.tar.gz
                  asset_name: flowsurface-x86_64-linux.tar.gz
                  asset_content_type: application/gzip
              continue-on-error: true

            - name: Upload Linux ARM asset
              if: ${{ inputs.build_linux_arm }}
              uses: actions/upload-release-asset@v1
              with:
                  upload_url: ${{ needs.create-release.outputs.upload_url }}
                  asset_path: ./artifacts/linux-arm/flowsurface-aarch64-linux.tar.gz
                  asset_name: flowsurface-aarch64-linux.tar.gz
                  asset_content_type: application/gzip
              continue-on-error: true

            - name: Upload macOS Universal asset
              if: ${{ inputs.build_macos_universal }}
              uses: actions/upload-release-asset@v1
              with:
                  upload_url: ${{ needs.create-release.outputs.upload_url }}
                  asset_path: ./artifacts/macos-universal/flowsurface-universal-macos.tar.gz
                  asset_name: flowsurface-universal-macos.tar.gz
                  asset_content_type: application/gzip
              continue-on-error: true

    generate-checksums:
        needs: [create-release, add-assets]
        name: "ðŸ”’ Generate Checksums"
        if: ${{ always() && inputs.create_release && needs.create-release.result == 'success' }}
        runs-on: ubuntu-latest
        steps:
            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts
              continue-on-error: true

            - name: Generate checksums
              run: |
                  touch SHA256SUMS
                  
                  # Windows
                  if [ -f "artifacts/windows-x64/flowsurface-x86_64-windows.zip" ]; then
                    sha256sum artifacts/windows-x64/flowsurface-x86_64-windows.zip | awk '{print $1 "  flowsurface-x86_64-windows.zip"}' >> SHA256SUMS
                  fi
                  
                  # Linux x64
                  if [ -f "artifacts/linux-x64/flowsurface-x86_64-linux.tar.gz" ]; then
                    sha256sum artifacts/linux-x64/flowsurface-x86_64-linux.tar.gz | awk '{print $1 "  flowsurface-x86_64-linux.tar.gz"}' >> SHA256SUMS
                  fi
                  
                  # Linux ARM
                  if [ -f "artifacts/linux-arm/flowsurface-aarch64-linux.tar.gz" ]; then
                    sha256sum artifacts/linux-arm/flowsurface-aarch64-linux.tar.gz | awk '{print $1 "  flowsurface-aarch64-linux.tar.gz"}' >> SHA256SUMS
                  fi
                  
                  # macOS Universal
                  if [ -f "artifacts/macos-universal/flowsurface-universal-macos.tar.gz" ]; then
                    sha256sum artifacts/macos-universal/flowsurface-universal-macos.tar.gz | awk '{print $1 "  flowsurface-universal-macos.tar.gz"}' >> SHA256SUMS
                  fi
                  
                  echo "=== Generated Checksums ==="
                  cat SHA256SUMS

            - name: Upload checksums
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ needs.create-release.outputs.upload_url }}
                  asset_path: ./SHA256SUMS
                  asset_name: SHA256SUMS
                  asset_content_type: text/plain
              continue-on-error: true
